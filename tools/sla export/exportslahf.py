import json
import os
from platform import platform
import sys
import csv
import zipfile
import toml
import requests
import time
sys.path.insert(0, os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))),'lib'))
import risksense_api as rsapi
import zipfile

class getslaoverdue:

    def __init__(self):
            conf_file = os.path.join(os.path.abspath(os.path.dirname(__file__)), 'conf', 'conf.toml')
            config = self.read_config_file(conf_file)
            self.rs_platform = config['platform_url']
            self.api_key = config['api_key']
            self.client_id=config['client_id']
            self.filename=config['filename']
            self.slaname=config['slaname'].lower()
            self.sladataoperator=config['sladataoperator']
            self.rs = rsapi.RiskSenseApi(self.rs_platform,self.api_key)
            print(self.slaname)
            self.slaoverduehosts()
    
    def read_config_file(self,filename):
            """
            Reads a TOML-formatted configuration file.

            :param filename:    Path to the TOML-formatted file to be read.
            :type  filename:    str

            :return:  Values contained in config file.
            :rtype:   dict
            """

            try:
                data = toml.loads(open(filename).read())
                return data
            except (Exception, FileNotFoundError, toml.TomlDecodeError) as ex:
                print("Error reading configuration file.")
                print(ex)
                print()
                exit(1)      
    def slaoverduehosts(self):
            exporthostfindingsurl = f"{self.rs_platform}/api/v1/client/{self.client_id}/hostFinding/export"
            exporthostfindingsbody={"fileName":"findings","fileType":"CSV","noOfRows":"All","filterRequest":{"filters":[{"field":"sla_rule_name","exclusive":False,"operator":"IN","orWithPrevious":False,"implicitFilters":[],"value":f"{self.slaname},"},{"field":"has_met_sla","exclusive":False,"operator":f"{self.sladataoperator}","orWithPrevious":False,"implicitFilters":[],"value":""}]},"exportableFields":[{"heading":"asset_options","fields":[{"identifierField":"addressType","displayText":"Address Type","sortable":False,"fieldOrder":1,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"criticality","displayText":"Asset Criticality","sortable":False,"fieldOrder":2,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"tags","displayText":"Asset Tags","sortable":False,"fieldOrder":3,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbAssetCriticality","displayText":"CMDB Asset Criticality","sortable":False,"fieldOrder":4,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbAssetTags","displayText":"CMDB Asset Tags","sortable":False,"fieldOrder":5,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField1","displayText":"CMDB Custom Field 1","sortable":False,"fieldOrder":6,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField10","displayText":"CMDB Custom Field 10","sortable":False,"fieldOrder":7,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField2","displayText":"CMDB Custom Field 2","sortable":False,"fieldOrder":8,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField3","displayText":"CMDB Custom Field 3","sortable":False,"fieldOrder":9,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField4","displayText":"CMDB Custom Field 4","sortable":False,"fieldOrder":10,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField5","displayText":"CMDB Custom Field 5","sortable":False,"fieldOrder":11,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField6","displayText":"CMDB Custom Field 6","sortable":False,"fieldOrder":12,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField7","displayText":"CMDB Custom Field 7","sortable":False,"fieldOrder":13,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField8","displayText":"CMDB Custom Field 8","sortable":False,"fieldOrder":14,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbCustomField9","displayText":"CMDB Custom Field 9","sortable":False,"fieldOrder":15,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbFERPAComplianceAsset","displayText":"CMDB FERPA Compliance Asset","sortable":False,"fieldOrder":16,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbHIPAAComplianceAsset","displayText":"CMDB HIPAA Compliance Asset","sortable":False,"fieldOrder":17,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbLastScanned","displayText":"CMDB Last Scanned","sortable":False,"fieldOrder":18,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbLocation","displayText":"CMDB Location","sortable":False,"fieldOrder":19,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbMacAddress","displayText":"CMDB Mac Address","sortable":False,"fieldOrder":20,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbManagedBy","displayText":"CMDB Managed By","sortable":False,"fieldOrder":21,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbManufacturedBy","displayText":"CMDB Manufactured By","sortable":False,"fieldOrder":22,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbModel","displayText":"CMDB Model","sortable":False,"fieldOrder":23,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbOperatingSystem","displayText":"CMDB Operating System","sortable":False,"fieldOrder":24,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbOwnedBy","displayText":"CMDB Owned By","sortable":False,"fieldOrder":25,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbPCIComplianceAsset","displayText":"CMDB PCI Compliance Asset","sortable":False,"fieldOrder":26,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbSupportGroup","displayText":"CMDB Support Group","sortable":False,"fieldOrder":27,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cmdbSupportedBy","displayText":"CMDB Supported By","sortable":False,"fieldOrder":28,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"critical","displayText":"Critical","sortable":False,"fieldOrder":29,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"discoveredOn","displayText":"Discovered On","sortable":False,"fieldOrder":30,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"dns","displayText":"DNS","sortable":False,"fieldOrder":31,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ec2Identifier","displayText":"EC2 identifier","sortable":False,"fieldOrder":32,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"expanse_asset_identifier","displayText":"Expanse Asset Identifier","sortable":False,"fieldOrder":33,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"exploit","displayText":"Exploit","sortable":False,"fieldOrder":34,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"agent_id","displayText":"FalconSpotlight Agent ID","sortable":False,"fieldOrder":35,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"findingsCount","displayText":"Finding Count","sortable":False,"fieldOrder":36,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"assetIdentifiedBy","displayText":"First Asset Identified By","sortable":False,"fieldOrder":37,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"assetIdentifier","displayText":"First Asset Identifier","sortable":False,"fieldOrder":38,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerFirstDiscoveredOn","displayText":"First Discovered On","sortable":False,"fieldOrder":39,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"platformFirstIngestedOn","displayText":"First Ingested On","sortable":False,"fieldOrder":40,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"fqdn","displayText":"FQDN","sortable":False,"fieldOrder":41,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"groupIds","displayText":"Group Ids","sortable":False,"fieldOrder":42,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"groupNames","displayText":"Group Names","sortable":False,"fieldOrder":43,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"high","displayText":"High","sortable":False,"fieldOrder":44,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"hostId","displayText":"Id","sortable":False,"fieldOrder":45,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"info","displayText":"Info","sortable":False,"fieldOrder":46,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ipAddress","displayText":"IP Address","sortable":False,"fieldOrder":47,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"easilyExploitable","displayText":"Is Easily Exploitable","sortable":False,"fieldOrder":48,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"lastAssetIdentifiedBy","displayText":"Last Asset Identified By","sortable":False,"fieldOrder":49,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"lastAssetIdentifier","displayText":"Last Asset Identifier","sortable":False,"fieldOrder":50,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"lastCredentialedScanDate","displayText":"Last Credentialed Scan","sortable":False,"fieldOrder":51,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerLastDiscoveredOn","displayText":"Last Discovered On","sortable":False,"fieldOrder":52,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"lastFoundOn","displayText":"Last Found On","sortable":False,"fieldOrder":53,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"platformLastIngestedOn","displayText":"Last Ingested On","sortable":False,"fieldOrder":54,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"low","displayText":"Low","sortable":False,"fieldOrder":55,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"macAddress","displayText":"MAC address","sortable":False,"fieldOrder":56,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"medium","displayText":"Medium","sortable":False,"fieldOrder":57,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"metricsOverrideDate","displayText":"Metric Exclude Override Date","sortable":False,"fieldOrder":58,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"metricsOverrideType","displayText":"Metric Exclude Override Status","sortable":False,"fieldOrder":59,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"metricsOverrideUser","displayText":"Metric Exclude Override User","sortable":False,"fieldOrder":60,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"hostname","displayText":"Name","sortable":False,"fieldOrder":61,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"netbios","displayText":"NetBIOS","sortable":False,"fieldOrder":62,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"network","displayText":"Network","sortable":False,"fieldOrder":63,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"networkType","displayText":"Network Type","sortable":False,"fieldOrder":64,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"device_id","displayText":"Nexpose Device ID","sortable":False,"fieldOrder":65,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"osName","displayText":"OS Name","sortable":False,"fieldOrder":66,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ports","displayText":"Ports","sortable":False,"fieldOrder":67,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"QG_HOSTID","displayText":"Qualys Host ID","sortable":False,"fieldOrder":68,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"rs3","displayText":"RS3","sortable":False,"fieldOrder":69,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"services","displayText":"Services","sortable":False,"fieldOrder":70,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"sla_rule_name","displayText":"SLA Name","sortable":False,"fieldOrder":71,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"host_uuid","displayText":"Tenable Host UUID","sortable":False,"fieldOrder":72,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"tenable_uuid","displayText":"Tenable UUID","sortable":False,"fieldOrder":73,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ticketsId","displayText":"Tickets Id","sortable":False,"fieldOrder":74,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ticketsLink","displayText":"Tickets Link","sortable":False,"fieldOrder":75,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ticketsStatus","displayText":"Tickets Status","sortable":False,"fieldOrder":76,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vrrCritical","displayText":"VRR Critical","sortable":False,"fieldOrder":77,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vrrHigh","displayText":"VRR High","sortable":False,"fieldOrder":78,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vrrInfo","displayText":"VRR Info","sortable":False,"fieldOrder":79,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vrrLow","displayText":"VRR Low","sortable":False,"fieldOrder":80,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vrrMedium","displayText":"VRR Medium","sortable":False,"fieldOrder":81,"selected":False,"sortOrder":0,"sortType":"ASC"}]},{"heading":"finding_options","fields":[{"identifierField":"criticality","displayText":"Asset Criticality","sortable":False,"fieldOrder":1,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"assignedTo","displayText":"Assigned To","sortable":False,"fieldOrder":2,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cves","displayText":"CVEs Associated","sortable":False,"fieldOrder":3,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cvss2Score","displayText":"CVSS 2.0","sortable":False,"fieldOrder":4,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cvss2Vector","displayText":"CVSS 2.0 Vector","sortable":False,"fieldOrder":5,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cvss3Score","displayText":"CVSS 3.0","sortable":False,"fieldOrder":6,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"cvss3Vector","displayText":"CVSS 3.0 Vector","sortable":False,"fieldOrder":7,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"discoveredOn","displayText":"Discovered On","sortable":False,"fieldOrder":8,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"dns","displayText":"DNS","sortable":False,"fieldOrder":9,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"dueDate","displayText":"Due Date","sortable":False,"fieldOrder":10,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ec2Identifier","displayText":"EC2 identifier","sortable":False,"fieldOrder":11,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"expanse_asset_identifier","displayText":"Expanse Asset Identifier","sortable":False,"fieldOrder":12,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"expireDate","displayText":"Expire Date","sortable":False,"fieldOrder":13,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"exploits","displayText":"Exploits","sortable":False,"fieldOrder":14,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"agent_id","displayText":"FalconSpotlight Agent ID","sortable":False,"fieldOrder":15,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"findingType","displayText":"Finding Type","sortable":False,"fieldOrder":16,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"assetIdentifiedBy","displayText":"First Asset Identified By","sortable":False,"fieldOrder":17,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"assetIdentifier","displayText":"First Asset Identifier","sortable":False,"fieldOrder":18,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerFirstDiscoveredOn","displayText":"First Discovered On","sortable":False,"fieldOrder":19,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"platformFirstIngestedOn","displayText":"First Ingested On","sortable":False,"fieldOrder":20,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"fqdn","displayText":"FQDN","sortable":False,"fieldOrder":21,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"groupIds","displayText":"Group Ids","sortable":False,"fieldOrder":22,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"groupNames","displayText":"Group Names","sortable":False,"fieldOrder":23,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"defaultCredentials","displayText":"Has Default Credentials","sortable":False,"fieldOrder":24,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"hasTicket","displayText":"Has Ticket","sortable":False,"fieldOrder":25,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"hostId","displayText":"Host Id","sortable":False,"fieldOrder":26,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"host","displayText":"Host Name","sortable":False,"fieldOrder":27,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"id","displayText":"Id","sortable":False,"fieldOrder":28,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ipAddress","displayText":"IP Address","sortable":False,"fieldOrder":29,"selected":True,"sortOrder":0,"sortType":"ASC"},{"identifierField":"lastAssetIdentifiedBy","displayText":"Last Asset Identified By","sortable":False,"fieldOrder":30,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"lastAssetIdentifier","displayText":"Last Asset Identifier","sortable":False,"fieldOrder":31,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerLastDiscoveredOn","displayText":"Last Discovered On","sortable":False,"fieldOrder":32,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"lastFoundOn","displayText":"Last Found On","sortable":False,"fieldOrder":33,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"platformLastIngestedOn","displayText":"Last Ingested On","sortable":False,"fieldOrder":34,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"macAddress","displayText":"MAC address","sortable":False,"fieldOrder":35,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"malware","displayText":"Malware","sortable":False,"fieldOrder":36,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"netbios","displayText":"NetBIOS","sortable":False,"fieldOrder":37,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"network","displayText":"Network","sortable":False,"fieldOrder":38,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"networkType","displayText":"Network Type","sortable":False,"fieldOrder":39,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"device_id","displayText":"Nexpose Device ID","sortable":False,"fieldOrder":40,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"notes","displayText":"Notes","sortable":False,"fieldOrder":41,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"originalAggregatedSeverity","displayText":"Original Aggregated Severity","sortable":False,"fieldOrder":42,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"osName","displayText":"OS Name","sortable":False,"fieldOrder":43,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"patchId","displayText":"Patch Id","sortable":False,"fieldOrder":44,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"patchTitle","displayText":"Patch Title","sortable":False,"fieldOrder":45,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"pluginCpes","displayText":"Plugin CPE","sortable":False,"fieldOrder":46,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"port","displayText":"Port","sortable":False,"fieldOrder":47,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"possiblePatches","displayText":"Possible Patches","sortable":False,"fieldOrder":48,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"possibleSolution","displayText":"Possible Solution","sortable":False,"fieldOrder":49,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"QG_HOSTID","displayText":"Qualys Host ID","sortable":False,"fieldOrder":50,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ransomwareFamily","displayText":"Ransomware Family","sortable":False,"fieldOrder":51,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"resolvedOn","displayText":"Resolved On","sortable":False,"fieldOrder":52,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scanDate","displayText":"Scan Date","sortable":False,"fieldOrder":53,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerName","displayText":"Scanner Name","sortable":False,"fieldOrder":54,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerOutput","displayText":"Scanner Output","sortable":False,"fieldOrder":55,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerPluginId","displayText":"Scanner Plugin ID","sortable":False,"fieldOrder":56,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"scannerReportedSeverity","displayText":"Scanner Reported Severity","sortable":False,"fieldOrder":57,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"service","displayText":"Service","sortable":False,"fieldOrder":58,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"severity","displayText":"Severity","sortable":False,"fieldOrder":59,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"severityGroup","displayText":"Severity Group","sortable":False,"fieldOrder":60,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"severityOverride","displayText":"Severity Override","sortable":False,"fieldOrder":61,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"status","displayText":"Status","sortable":False,"fieldOrder":62,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"tags","displayText":"Tags","sortable":False,"fieldOrder":63,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"host_uuid","displayText":"Tenable Host UUID","sortable":False,"fieldOrder":64,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"tenable_uuid","displayText":"Tenable UUID","sortable":False,"fieldOrder":65,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"testStatus","displayText":"Test Status","sortable":False,"fieldOrder":66,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ticketsId","displayText":"Tickets Id","sortable":False,"fieldOrder":67,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ticketsLink","displayText":"Tickets Link","sortable":False,"fieldOrder":68,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"ticketsStatus","displayText":"Tickets Status","sortable":False,"fieldOrder":69,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vrrGroup","displayText":"VRR Group","sortable":False,"fieldOrder":70,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vulnerability","displayText":"Vulnerability","sortable":False,"fieldOrder":71,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"riskRating","displayText":"Vulnerability Risk Rating","sortable":False,"fieldOrder":72,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"vulnerabilityType","displayText":"Vulnerability Type","sortable":False,"fieldOrder":73,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"workflowBatchCreated","displayText":"Workflow Create Date","sortable":False,"fieldOrder":74,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"workflowBatchCreatedBy","displayText":"Workflow Created By","sortable":False,"fieldOrder":75,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"workflowBatchExpiration","displayText":"Workflow Expiration Date","sortable":False,"fieldOrder":76,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"workflowBatchId","displayText":"Workflow Id","sortable":False,"fieldOrder":77,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"workflowBatchReason","displayText":"Workflow Reason","sortable":False,"fieldOrder":78,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"workflowBatchState","displayText":"Workflow State","sortable":False,"fieldOrder":79,"selected":False,"sortOrder":0,"sortType":"ASC"},{"identifierField":"workflowBatchUserNote","displayText":"Workflow State User Note","sortable":False,"fieldOrder":80,"selected":False,"sortOrder":0,"sortType":"ASC"}]}]}
            
            header={"accept":"application/json","x-api-key":f"{self.api_key}","Content-Type":"application/json"}
            try: 
                jobid=(requests.post(url=f'{self.rs_platform}/api/v1/client/{self.client_id}/hostFinding/export',
                headers=header,data=json.dumps(exporthostfindingsbody))).json()
            except (rsapi.RequestFailed, rsapi.MaxRetryError, rsapi.StatusCodeError, ValueError) as ex:
                print(ex)
                print()
                print("Unable to export the file.")
                sys.exit("Exiting")
            print(jobid)
            self.jobid=jobid['id'] 
            
            while(True):
                try:
                    exportstatus=self.rs.exports.check_status(self.jobid,self.client_id)
                    print(exportstatus)
                    if exportstatus=='COMPLETE':
                        break
                    elif exportstatus=='ERROR':
                        print('error getting zip file please check ')
                        exit()
                except (rsapi.RequestFailed, rsapi.MaxRetryError, rsapi.StatusCodeError, ValueError) as ex:       
                    print(ex)
                    print()
                    print("Unable to export the file.")
                    sys.exit("Exiting")
            try:   
                self.rs.exports.download_export(self.jobid,f"{self.filename}.zip",self.client_id)
                with zipfile.ZipFile(f"{self.filename}.zip","r") as zip_ref:
                    zip_ref.extractall("findingsdata")
            except(rsapi.RequestFailed, rsapi.MaxRetryError, rsapi.StatusCodeError, ValueError):
                    print(ex)
                    print()
                    print("Unable to retrieve saved filter definition. Exiting.")
                    sys.exit(1)

        
            self.rs.exports.delete_files(self.jobid,self.client_id)


if __name__ == "__main__":
    try:
        getslaoverdue()
    except KeyboardInterrupt:
        print()
        print("KeyboardInterrupt detected.  Exiting...")
        print()
        sys.exit(0)